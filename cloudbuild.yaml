steps:
# --- Backend Build & Deploy ---

# 1. Build the backend container image
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Backend'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/guestbook-backend:$COMMIT_SHA', './backend']

# 2. Push the backend image to Google Container Registry
- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Backend'
  args: ['push', 'gcr.io/$PROJECT_ID/guestbook-backend:$COMMIT_SHA']

# 3. Deploy the backend to Cloud Run
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'Deploy Backend'
  entrypoint: gcloud
  args: [
    'run', 'deploy', 'guestbook-backend',
    '--image=gcr.io/$PROJECT_ID/guestbook-backend:$COMMIT_SHA',
    '--region=us-central1',
    '--allow-unauthenticated',
    '--platform=managed',
    # --- Configuration for Database and Secrets ---
    # Replace with your project number and Cloud SQL instance name
    '--add-cloudsql-instances=$PROJECT_ID:us-central1:your-sql-instance-name',
    '--set-env-vars=GCS_BUCKET=your-gcs-bucket-name',
    # Mount secrets as environment variables
    '--set-secrets=DATABASE_URL=DATABASE_URL:latest,JWT_SECRET=JWT_SECRET:latest'
  ]

# --- Frontend Build & Deploy ---

# 4. Build the frontend container image
- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Frontend'
  args: ['build', '-t', 'gcr.io/$PROJECT_ID/guestbook-frontend:$COMMIT_SHA', './frontend']

# 5. Push the frontend image
- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Frontend'
  args: ['push', 'gcr.io/$PROJECT_ID/guestbook-frontend:$COMMIT_SHA']

# 6. Deploy the frontend to Cloud Run
- name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
  id: 'Deploy Frontend'
  entrypoint: gcloud
  args: [
    'run', 'deploy', 'guestbook-frontend',
    '--image=gcr.io/$PROJECT_ID/guestbook-frontend:$COMMIT_SHA',
    '--region=us-central1',
    '--allow-unauthenticated',
    '--platform=managed',
    # This is the magic part: it gets the backend's URL and passes it to the frontend
    '--set-env-vars=BACKEND_URL=https://guestbook-backend-$(gcloud run services describe guestbook-backend --platform managed --region us-central1 --format="value(status.address.url)" | cut -d/ -f3)'
  ]

images:
- 'gcr.io/$PROJECT_ID/guestbook-backend:$COMMIT_SHA'
- 'gcr.io/$PROJECT_ID/guestbook-frontend:$COMMIT_SHA'

# --- Configuration for Secret Manager ---
# This section grants the Cloud Build service account permission to access the secrets.
options:
  serviceAccount: 'projects/$PROJECT_ID/serviceAccounts/cloud-build-private-pool-sa' # Or your Cloud Build service account

secretManager:
- versionName: projects/$PROJECT_ID/secrets/DATABASE_URL/versions/latest
  env: 'DATABASE_URL'
- versionName: projects/$PROJECT_ID/secrets/JWT_SECRET/versions/latest
  env: 'JWT_SECRET'
